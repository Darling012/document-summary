# 关于实体关联关系设计

## 问题
1. 中间表、关联表、关系表应该表达的是一个意思
2. 增加一个关联字段还是增加关联表？

## 分析

可以表达关联关系的方式
1. 单个关联字段
	1. `1:n`，一个[数组](MySQL数据类型.md#数组)字段里放关联的数据组
		1. 修改其中某个数据值怎么办？全量更新，通过回显再次传入更新后的数据组
	2. `1:1`
2. 多个关联字段
	1. 同单个
3. 关联表

关联数据内容有两种情况，一个属性，或多个属性。一个属性只有一对多情况有可能拆到表里。
关联关系存在两种情况，一对一，或者一对多
业务操作也存在两种情况，只有左查或有左查右查。
关联关系存储分为四种情况，主表存关联数据、主表存从表 id、从表存主表 id，增加一张中间表存主表从表关系。

用主表存关联数据，像文档数据库一样。那么关联内容就不易进行搜索，因为需要分割及模糊查询。所以用字段关联情况适用于，关联内容单独存在意义不大，就是主数据的附件。不会对关联内容存在有关业务的操作，只是增删改查。比如邮件的附件，就是属于邮件的，且脱离邮件没意义，那就应该直接用数据字段存储 url；假如存在搜索情况，会单独搜索某个附件，就说明附件有其他信息，有个附件表且此附件表只对当前表有意义，然后存附件 id。

关联表的优势在于，关联关系易于添加，且不对主表产生修改主表都是业务相关内容，也不用考虑用字段关联时所选类型长度问题。这种情况关联数据一般也是业务表，也有自己的业务操作。


1. `1:1`
	1.  一个属性 其实这种情况并不属于具有 <font color= #81B300 >关联关系</font>
		1. 只存在左查
			1. 主表存关联数据
		2. 左查右查都存在
			1. 主表存关联数据，此字段为提高效率建索引
	2. 多个属性
		1. <font color= #2485E3 >只存在左查</font>，
			1. 主表存关联数据，json
			2. 从表存主表 id，美观结构化，但是是在关联表中加主表 id, 不能采用主表存关联 id，不然在主表中加关联表 id，当关联表数据删除后，主表的关联 id 就无效了
		2.  <font color= #C32E94 >左查右查都存在</font>
			1. 主表存关联数据，分割模糊查询，不合理
			2. 从表存主表 id
2. `1:n`
	1. 一个属性
		1. 只存在左查
			1. 主表存关联数据，array、json 直接存
			2. 从表存主表 id，此种情况是把 一个属性也列出来的原因。比如附件表，可能只存在三个字段 id、主表 id、url。
		2. 左查右查都存在
			1. 主表存关联数据，考虑分割及模糊查询
			2. 从表存主表 id，感觉比用字段也没方便哪去
	2. 多个属性
		1. <font color= #2485E3 >只存在左查</font>
			1. 主表存关联数据，一个字段里塞了太多数据，考虑长度
			2. 关联表存主表 id，要美观的多，不过作用也就仅仅是美观
		2. <font color= #C32E94 >左查右查都存在</font>
			1. 主表存关联数据，已经不合适了，分割太麻烦了，多条数据+单条数据多个属性
			2. 关联表存主表 id，关联查询方便的多

主表存从表 id 不如 从表存主表 id 耦合度低，增加一张中间表存主表从表关系耦合度更低，适用于改进主表存关联 id 情况。比如学生-班级场景，学生表增加班级满足查询学生时带出班级信息，此为关联表存主表 id。但当有查询某个班级下所有学生时，就需要遍历整个学生表，此时增加一个中间表维护班级学生关系，就快的多。
再是 `n:n` 关系只能是增加中间表，不然太乱。


## 总结
1. 考虑主表能不能忍受增加关联信息
2. 考虑单字段存储合理性
3. 考虑只存在左查还是左查右查都存在
4. 考虑执查询效率


## reference
[如何在 MySQL 中存储数组](https://www.delftstack.com/zh/howto/mysql/store-array-in-mysql/)

[一对多关系的数据库表，是用加字段实现还是增加记录行来实现？ - V2EX](https://www.v2ex.com/t/460860)
1. 加表的感觉就是增加了复杂度，对比加字段方式，本来查到角色就能直接知道他有哪些资源了，现在还要再查一次数据库；角色更新他资源的频率很低，每次更新都是直接覆盖替换，如果中间表的话还要先删再插入，代码量多出不少
	1. 并不需要再次查数据库，sql 可以关联出来
2. 逗号分隔这种事情，直接违反一范式了
	1. PostgreSQL 有数组，mysql 的 json 格式也能满足
3. 如果你有要查询哪些角色有指定资源这种查询，最好还是用中间表不然你用字段，是需要解析这个字段的，或者用 like， 效率都没有用中间表+索引效率高
	1. 这种情况算是对关联数据有业务操作，为查找关联数据中某种的情况
4. 加表扩展性好、每个表内容更纯粹、关联数据业务操作方便
	1. 关联表比较好，这样的话无论是以左条件查右或者是以右条件查左都方便
	2. 其实也是个演变的过程，你先用字段代替加关联表，等哪天碰到字段搞不定了（不如有快速右查的需求），加个关联表也很简单
	3. 无脑加表。加表更能应对需求变更。
	4.  一般加表，每个表数据最小化

[表关联字段的存放的设计_ITPUB博客](http://blog.itpub.net/617982/viewspace-2136637/)
1. `班级-学生` 
	1.  `1:n` ，存在查询学生显示他属于哪个班级，以及哪个班级下有哪些学生，左查右查都存在，且此情况是一个学生只属于一个班级
	2. 可以在学生表中增加 classID 字段，此字段加索引提高查询效率。就能满足两种查询。
2. `邮件-附件`
	1. `1:n`，假如不存在需要查询某个附件情况，感觉直接放一个数据字段就行
	2. 此例举得是存在，加了附件表，附件中的 emailID 不会变更，不会出现数据一致性问题（学生修改 classID 也没一致性问题啊）
3. `商品-描述`
	1. `1:1`，是把描述 id 放入商品表，还是反过来。这里我认为都不用加表，某商品不存在描述空着就是了。
	2. 考虑冗余 ID 的代价，在商品中增加描述 id，假如描述数据删除后，商品就会关联不出来。
	3. 在描述中增加 goodsID, 描述删除后对商品不产生影响。
4. `多个关联关系`
	1. 工作记录表，存在审核 id，投诉 id
	2. 采用俩字段分别存


[左连接 ，右连接，内连接和全外连接的4者区别\_左连接 右连接 内连接 外连接的区别\_灰太狼\_cxh的博客-CSDN博客](https://blog.csdn.net/weixin_39220472/article/details/81193617)
