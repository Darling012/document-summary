# 计数器

1. 页面计数业务策略[文章浏览量设计](https://blog.52itstyle.vip/archives/4271/)


## 背景
即实现计数功能，比如页面访问量，投票等等。在天元的物业项目的浏览量用的 juc 的 atomic，现在感觉没啥意义。因为存在从数据库读取数据赋值给 atomic，再落库的过程。这两步还是要加锁。




[spring data jpa mysql 乐观锁 与 AtomicInteger\_pois的博客-CSDN博客](https://blog.csdn.net/silyvin/article/details/75078694)
1. 代码锁
2. 数据库锁
	1. 数据库乐观锁
	2. 数据库悲观锁

代码锁在将更新操作的入口锁住，当存在并发时，只有一个线程能执行这段代码。涉及到，读取数据库，更新实体，再存入数据库的操作。这种写法存在两个小问题
1. 粒度相对较高，每篇文件应该是单独计数，这种写法使得两篇文章的计数更新也成了线性。
2. 分布式场景失效

数据库乐观锁逻辑
1. 先 select, 读取 versionValue
2. 然后更新时：`update task set value = newValue,version =  versionValue + 1   where version = versionValue;`
当存在并发时，只有一个节点数据能更新成功，利用 mysql 的原子操作。 #todo  需要具体了解乐观锁实现机制 [Mysql锁](Mysql锁.md)

### 数据库计数
[MySQL计数器、每日计数器表设计与调优 - 腾讯云开发者社区-腾讯云](https://cloud.tencent.com/developer/article/1824549)
[mysql 计数器实现 - 简书](https://www.jianshu.com/p/153e052765c0)
[MySQL：如何实现高性能高并发的计数器功能（如：网站点击数） - 墨天轮](https://www.modb.pro/db/78059)
提供了一种 **以空间换时间** 高并发思路，比如把一篇文章的计数分为 10 条记录，那么更新时就可以任选一条更新提高并发（分槽 slot），查询时 sum。

