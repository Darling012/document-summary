[探活与数据同步](探活与数据同步.md)
## 场景

1.  每场试考完后，调用AI打分服务进行打分，打完后分值及视频更新到业务系统中。
2.  其中，一场考试有多个考生，可能有多场考试且存在优先级，可能有多个计算节点能够提供打分服务。
3.  假如某场考试有10个考生，2个可用计算节点。那么一场考试考完后：
    1.  判断是否需要AI打分
    2.  将2个考生分配给2个可用计算节点
    3.  剩余8个考生入库，等到计算节点回调
    4.  回调后再取两个考生，再次调用计算节点，直到库中没有需要打分的考生。

### 可用计算节点队列

1.  计算节点会存在动态增删，比如失活，比如增加计算节点。
2.  在分配任务时，需要从可用计算节点队列中选取节点
3.  节点状态
    1.  空闲
    2.  忙碌

### 任务持久化表

1.  需要AI打分的考生数量远远超过节点数量，所以我们需要对打分任务进行持久化。
2.  任务状态：
    1.  未分配
    2.  已分配
    3.  超时（AI打分单个任务时长限制）
    4.  超期（人工打分时间节点限制）
    5.  已完成

### 任务节点关系临时表

1.  计算节点进行AI打分时消耗时间过长，此时会存在宕机情况。
2.  当节点出现宕机后，要重新将任务分配。
3.  只保存关系，不保存状态

## 调用逻辑

### 数据来源
1.  考试结束后判断是否需要AI打分，需要则考生考卷进入任务表
2.  有新节点注册后加入可用计算节点队列

### 交互逻辑：

1.  从任务表中取一个任务更改状态为已分配，从可用计算节点中选择空闲节点，分配任务。
2.  收到节点回调后，从任务表中取同场考试未分配任务继续。没有未分配任务则停止。

### 定时任务

1.  心跳探活
    1.  节点失活根据节点状态存在两种处理。
        1.  空闲节点，从可用节点对列中删除即可
        2.  忙碌节点，需要从任务节点关系表中查询中所关联任务，更新任务状态为未分配。
2.  节点状态
    1.  扫描节点对列是否有空闲节点，再查询任务表是否有未分配任务。调用交互逻辑。
    2.  此种情况出现在有新节点注册上来。
3.  任务状态
    1.  有超期任务，进行任务重新分配，及通知计算节点任务超期。
    2.  是否有未分配任务，再判断是否有空闲节点，进行交互逻辑

### 什么时机触发AI打分
1.  考试结束后判断是否需要AI打分，此时存在两种情况
    1.  有空闲节点，进行交互逻辑
    2.  没有空闲节点，任务被入库。
2.  定时任务，扫描有空闲节点及未分配任务

## 问题
1.  定时任务扫描节点还是扫描任务状态？
    1.  节点
        1.  节点不可用就可以不再往下走逻辑
    2.  任务
        1.  节点一直不可用，任务一直没有分配怎么办
        2.  任务还要加个超期的状态，为多长时间未完成AI打分，这个期限根据老师计划阅卷时间而来。
2.  探活方式
    1.  下发任务时根据返回状态判断节点状态
        1.  任务进行中节点卡死情况，这就需要周期性进行探死
            1.  假如存在周期扫描 AI 打分任务表的定时任务，可根据某个任务是否超期，再次调用下发任务接口，打破卡死状态。
    2.  心跳周期探活
## V1.0版本
##### 背景
1.  只有一个计算节点
    1.  暂且不需要计算节点队列
    2.  不需要进行探活，只根据调用AI打分接口时根据http状态码判断节点状态
        1.  单个任务节点卡死情况，通过定时任务检查任务是否超时解决（超时会再次调用）。
    3.  只需要一个任务表
##### 实现
1.  触发逻辑
    1.  考完试
    2.  定时任务
        1.  检查是否有进行中任务以及进行中任务是否超期
        2.  检查是否有未打分任务，若有则调用下发任务接口