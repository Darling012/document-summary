# 注册中心

## Nacos 注册中心

1.  [Nacos 服务注册与发现原理分析](https://mp.weixin.qq.com/s?__biz=MzA3MTQ2MDgyOQ==&mid=2247484167&idx=1&sn=a0b50779d871428ea09f956da0c07d82)
2. 
3. [Spring Cloud Alibaba——Nacos服务发现源码分析 - 简书](https://www.jianshu.com/p/f3c37e3abc23)
4. [你应该了解的Nacos注册中心](https://mp.weixin.qq.com/s?__biz=Mzg3MjA4MTExMw==&mid=2247492161&idx=2&sn=9a738e862eec5550437c1db0ed5c126c)

[Nacos作为注册中心-源码解析_flying~closer的博客-CSDN博客](https://blog.csdn.net/qq_16552433/article/details/107343775)
1. 客户端组装自己的服务信息，然后向服务端发起注册请求
2. 服务端接受到注册请求后，将服务信息加入到本地缓存
3. 服务端加入定时, 不断的检测服务是否健康，更新或删除注册的服务
4. 客户端启动时，spring 创建 fegin bean 时会从 nacos 获取 service 信息，并加入定时，不断拉取 fegin 对应模块的服务信息
5. 客户端在通过 fegin 调用时，会通过负载均衡算法，从本地缓存选择一个服务进行调用
6. 服务端接收到发现请求时，会根据条件从服务端本地缓存中获取对应的实例，封装好返回给客户端

### 服务发现


## 健康检查

[主动健康检查要点(Ribbon 为例) | 三点水](https://lotabout.me/2020/Active-Health-Check-With-Ribbon-Example/)


[服务探活的五种方式](https://mp.weixin.qq.com/s/tw4-BIUZqpJLLEd0n09GNg)
1. consumer 被动探活
	1. consumer 调用 provider 报错，时间窗口重试后判断失活，剔除
	2. 需要用真实流量探测
2. consumer 主动探活
	1. 用旁路方式检测，根据结果更新 provider 状态
	2. 阿里的 Tengine 开源了一个 nginx_upstream_check_module 模块来做主动健康检查
	3. 爱奇艺在Dubbo的Consumer侧增加了探活机制
3. provider 上报心跳
	1. provider 注册成功后一直向注册中心发送心跳包，注册中心定时检查。
	2. 想要更好的时效性，就必须缩短心跳间隔，从而会增加心跳请求量，每次心跳得更新每个节点的上次心跳时间，占用了大量资源。
	3. etcd、redis、nacos 1. x 采用
4. provider 与注册中心会话保持
	1. tcp 断开连接+长周期心跳
	2. Dubbo 使用的 Zookeeper，Nacos 2. x 版本 (gRPC) 的临时实例，SOFARegistry
5. 注册中心主动探测

[深入理解RPC—健康检测](https://blog.csdn.net/fangmeng1997/article/details/108775052)
1. 为什么要有健康检查
	1. 因为有了集群，所以每次发请求前，RPC 框架会根据路由和负载均衡算法选择一个具体的 IP 地址。为了保证请求成功，我们就需要确保每次选择出来的 IP 对应的连接是健康的
2. 服务方状态一般三种
	1. 健康状态
		1. 建立连接成功，心跳探活一直成功
	2. 亚健康状态
		1. 建立连接成功，心跳请求连续失败
	3. 死亡
		1. 建立连接失败
3. [心跳](https://blog.csdn.net/Revivedsun/article/details/84576974)判断维度
	1. 可用率
	2. [服务健康检查策略 - 简书](https://www.jianshu.com/p/3dc51679c369)
4. 解决因心跳探测模块故障误判
	1. 分布式部署心跳探测，有一个成功则认为健康

[springboot - 系统高可用之健康检查和健康度量那些事 - vivo 互联网技术 - SegmentFault 思否](https://segmentfault.com/a/1190000039903907)
1. 主动
	1. 主服务定时主动向节点发送 check
	2. 其实就是心跳，不过这里包含了其他信息
2. 被动
	1. 以正常连接情况或者业务请求的响应作为指标
	2. 就是在调用接口时根据接口状态判断

[Soul网关源码探秘《十一》 - 服务探活_rughru的博客-CSDN博客_服务探活 gui](https://blog.csdn.net/rughru/article/details/113210898) 关联 nacos
[微服务中如何创建有意义的健康检查_51CTO博客_微服务健康检查](https://blog.51cto.com/key3feng/5633899)
[Docker 容器健康检查机制-阿里云开发者社区](https://developer.aliyun.com/article/177494)

### Nacos 健康检测
[Spring Cloud Alibaba Nacos 的 2 种健康检查机制！ - Java中文社群 - 博客园](https://www.cnblogs.com/vipstone/p/15944689.html)
1. 客户端主动上报机制。
2. 服务器端反向探测机制。


[微服务：剖析一下源码，Nacos的健康检查竟如此简单 - 掘金](https://juejin.cn/post/6981208307457327118)


## reference
[如何组装一个注册中心？](https://mp.weixin.qq.com/s/qGZona_9HTi8yZzCCvd3RQ)
