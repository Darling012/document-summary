# 分布式锁

##### 问题
1. 为什么需要分布式锁？[Java锁](Java锁.md)
2. 运用什么思想解决了什么问题

##### Reference
1. [一句话说清分布式锁，进程锁，线程锁](https://www.cnblogs.com/intsmaze/p/6384105.html)
2. [关于分布式锁原理的一些学习与思考-redis分布式锁，zookeeper分布式锁](https://www.cnblogs.com/JJJ1990/p/10496850.html)
## Redis 分布式锁
1. Redis 实现分布式锁的几种方案，都是基于 `set if not exist` 即 SETNX 命令
2. 当 key 不存在（返回 OK）设置 key 值，存在（返回 nil）什么都不做
3. 高阶方案传参不一样，考虑了异常情况
##### 演进
1. 直接调用SETNX
	1. 问题：删除锁前出问题，导致死锁
	2. 解决：加锁自动过期时间
2. SETNX + 过期时间
	1. 问题：因为是两步操作，所以有可能过期时间未设置成功
	2. 解决：set 指令扩展参数，使得 setnx 和 expire 指令可以一起执行
3. 原子操作：占锁 + 设置锁过期时间
	1. 问题：A 任务未执行完，锁过期，B 获取锁，A 执行完释放了锁。因为是同一把锁，导致出现错误。
	2. 解决：获取锁时给锁加随机值参数，删除时判断随机值是否是当前线程设定的值，是再删
4. 锁 + 当前客户端加锁的标识
	1. 问题：获取锁、比较锁的值、删除锁，这三步是非原子性的。A 在删除锁操作前，锁过期。B 获取后，A 执行了删除操作。
	2. 解决：使用 Lua 脚本进行获取锁、比较锁、删除锁的原子操作
5. 多节点 redis 问题
	1. 在主节点获取锁后，未同步从节点前，主节点挂掉，再有申请锁造成冲突
	2. Redlock 算法，redLock算法虽然是需要多个实例，但是这些实例都是独自部署的，没有主从关系。
##### Reference
1. [Redis 分布式锁｜从青铜到钻石的五种演进方案 - 悟空聊架构的个人空间 - OSCHINA - 中文开源技术交流社区](https://my.oschina.net/u/4499317/blog/5039486)
2. [Redis实现分布式锁的演进和局限性 - 掘金](https://juejin.cn/post/6983562288280109092)
3. [Redis 分布式锁如何自动续期]( https://mp.weixin.qq.com/s/H2BNykjtvTlzKSRAaBD2yw )
4. [Spring Boot加一个注解，轻松实现 Redis 分布式锁](https://mp.weixin.qq.com/s/SpA5bHPV49-6hkdf5Xe9PA)


## [Redisson](redisson.md)
1. [分布式锁中的王者方案-Redisson](https://www.cnblogs.com/jackson0714/p/redisson.html)
2. [最强分布式锁工具：Redisson](https://mp.weixin.qq.com/s/2RIdKQphFI83ohGjdE0Jnw)
3. [最强分布式工具Redisson（一）：分布式锁 - 掘金](https://juejin.cn/post/6961380552519712798)