# 过期缓存和延迟队列

## 过期缓存
在看[限流](限流.md)时提到了滑动时间窗口，在 Hystrix和Sentinel中都有应用。在火灾探测项目中，对报警消息进行过滤也用到了相似思想，即时间段内多余的消息忽略。这跟 [[TCP]] 的滑动窗口还不带一样，tcp的是客户端发送的多次请求，只要没到窗口最大值，服务器可以缓存起来，响应后再删除。
然后这种在一定时间内或之后重新计算，又跟延迟队列差不多。

在K12中，封装了Guava的[过期map](https://albenw.github.io/posts/df42dc84/) 作为应用层限流工具。
在concrete中，也存在一个过期map。
在火灾探测中，使用 [DelayQueue](https://mp.weixin.qq.com/s/iwmIdeERsHoTuTcuszKz6g) 和 redis zset实现延迟队列。



## 延迟队列
1. [你真的知道怎么实现一个延迟队列吗 ？ - 知乎](https://zhuanlan.zhihu.com/p/266156267)


[延时任务队列的原理与实现总结](https://www.jianshu.com/p/a8c1458998aa)
1. 定时器轮询遍历数据库
2. JDK 的 DelayQueue
3. JDK 的 ScheduledExecutorService
4. 时间轮（netty）
5. 利用 quartz 等定时任务
6. RedisZset 实现
7. RabbitMQ 实现延时队列

[redis 延时任务 看一篇成高手系列2\_hjm4702192的博客-CSDN博客](https://blog.csdn.net/hjm4702192/article/details/80519010)

[你知道Redis可以实现延迟队列吗？](https://www.cnblogs.com/xiaowei123/p/13222710.html)
[一口气说出 6种 延时队列的实现方案，面试稳稳的 - 掘金](https://juejin.cn/post/6844904150703013901)
1. Java delayqueue
	1. [Java中的阻塞延迟队列DelayQueue原理和用法](https://mp.weixin.qq.com/s/iwmIdeERsHoTuTcuszKz6g)
2. redis
	1. zset
	2. pubsub
	3. stream
3. rabbitmq
	1. [RabbitMQ 延迟队列，消息延迟推送 - 海向 - 博客园](https://www.cnblogs.com/haixiang/p/10966985.html)
	2. [Rabbitmq延迟队列实现定时任务_RayeWang的博客-CSDN博客](https://blog.csdn.net/wantnrun/article/details/80401641)

### redis
[list、zset、pub\sub、stream](https://mp.weixin.qq.com/s/G31OEGmi0OtTBGIJT8g4jQ)
##### 过期回调
利用 Redis 过期回调实现延迟队列想当**不可靠**！Redis 不能确保 key 在指定时间被删除, 在 [Timing of expired events ](https://redis.io/topics/notifications#timing-of-expired-events) 中 , 明确的说明了 "Basically expired events **are generated when the Redis server deletes the key** and not when the time to live theoretically reaches the value of zero." 
1. [请勿过度依赖Redis的过期监听](https://juejin.cn/post/6844904158227595271) 
2. [SpringBoot实现监听redis key失效事件](https://www.jianshu.com/p/106f0eae07c8)
##### zset
1. [Redis 做延迟消息队列](https://mp.weixin.qq.com/s/_Dkj-DsbQ7B0J1GYzJ8Zeg)



## Reference
4. [Redis 深度历险：核心原理与应用实践](https://juejin.cn/book/6844733724618129422/section)

