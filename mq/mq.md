# MQ

##### 问题
1. mq 中队列以及 java 里的队列
2. amqp 中为什么定义了 chnnel
	1. tcp 创建和释放也要消耗时间, 在保持的 TCP 长连接里面去创建和释放
3. 怎么解决mq的
4. 


## 设计

《分布式消息申间件实践》第1章 消息队列
1. 系统间通信
	1. RPC
		1. 看起来跟调用本地方法一样
	2. 消息队列
		1. 生产者发送消息后，感兴趣的消费者都可以消费数据
		2. 生产者将消息发送到队列后不关心谁来取，消费者也不关心谁发的，队列负责消息的传递。
2. 为什么用消息队列
	1. 
3. 消息队列特点
	1. 消息：应用间传输的数据，表现形式多种。
	2. 队列：消息的进出，存贮和处理消息
	3. mq存在的问题
		1. 消息积压
		2.  消息持久化
		3. 可靠投递
		4. 消息重复
		5. 严格有序
		6. 集群问题

1. [深入解析分布式消息队列设计精髓](https://mp.weixin.qq.com/s/7NfpOjnEetbwp7owJ53Z4w)
2. [一文看懂三大主流MQ：RabbitMQ、RocketMQ、Kafka](https://mp.weixin.qq.com/s/i9Qvp29BkRwyjAzi_il9QQ)
3. [如何设计一个消息队列？0](https://mp.weixin.qq.com/s?__biz=MzIzMzgxOTQ5NA==&mid=2247487753&idx=2&sn=1f2a8032ec6f46d1e87ec1c88fa62a00)

#### 数据结构
[queue](Java/queue.md)

#### [发布-订阅消息模式](回调、观察者、事件监听、发布订阅.md#发布订阅模式)
‌‌ [消息队列原理_系统商研社的博客-CSDN博客_消息队列原理](https://blog.csdn.net/hongsejiaozhu/article/details/72867889)

 
‌‌‌　　[事件驱动型微服务中的并发问题](https://mp.weixin.qq.com/s/AUc20ynHZjE04l5WTStTuQ)
‌‌‌　　![](image-20220812105813134.png)




## 协议
##### 为什么有这么多的协议
《分布式消息申间件实践》第2章 [消息协议 ](https://www.cnblogs.com/Jyongli/p/15636435.html)
1. 就是需要大家都遵守的套规 。在计算机领域中，只要涉及不同的计算机之间要共同完成一  事情的时候，就肯定会有协议的存在，就像我们说话用某种语言一样，不 同的计算机之间必 须使用相同的语 才能进行通信
2. 常见的开放协议有 AMQP, MQTT STOMP, XMPP 等。有些特殊框架（如 Red Kafka ZeroMQ ）根据自身需要未严格遵循 MQ 规范，而是基于 TCP IP 自行封装了 协议，通过网 Socket 接口进行传输，实现了 MQ 的功能。这的协议可以简 地理解成对双方通信 个约定，比如传过来 衍流数据，其中第节表示什么， 字节表示什么，类似这样的约定。
3. AMQP
4. MQTT
5. STOMP
6. JMS

[MQTT, XMPP, WebSockets还是AMQP？泛谈实时通信协议选型](https://mp.weixin.qq.com/s/IyvKMTQY3Nzt719Bs09uyg)
1. 像TCP传输纯消息，一个发送一个接收。像在TCP上的WebSocket，添加了分割大消息等功能，但本质还是点对点传输消息。
2. 在涉及到复杂的系统时，就需要一个更高层次的通信范式"发布-订阅"。
3. 支持发布订阅的协议
	1. MQTT，二进制协议，TCP之上，也支持WebSocket，提供了一些特性，应用于低功耗的物联网设备
	2. STOMP，流文本协议，有事务和ack保证可靠性投递
	3. 选二进制还是文本
		1. 底层来说所有协议都是二进制。
		2. 二进制可以传输任何消息
		3. 由于在许多发布－订阅式的架构中，信息交换是基于文本的，所以许多协议选择简单地将整个信息转化为文本，从而降低复杂性并提高了可读性，当然带来的代价就是需要再消息接受后执行额外的计算任务。
	4. WAMP，结合了基于发布－订阅的请求/响应编程模型
4. 有些场景下，简单的发布－订阅模式还不够。这就是队列存在的场合：它支持多种不同的消息和存储的模式。
	1. AMQP，
	2. ZeroMQ，更轻量
	3. JMS，
### mq 如何选型
[Kafka,RabbitMQ,ZeroMQ,RocketMQ,ActiveMQ之间的差异](https://mp.weixin.qq.com/s?__biz=MzU2MTI4MjI0MQ==&mid=2247487160&idx=1&sn=5407d015b902849324fb3ddd77fc5aef)
## 问题

[四个问题](https://mp.weixin.qq.com/s?__biz=MzU0OTk3ODQ3Ng==&mid=2247485656&idx=1&sn=0b32619a76a8b058fc4e9acc43d48260)
### 为什么用 mq
[天天在用消息队列，却不知道为啥要用 MQ ，这就尴尬了 - 知乎](https://zhuanlan.zhihu.com/p/84007327)
1. 异步
	1. 生产者发送消息到 A 队列，消费者消费后把结果再发送到 B 队列，A 监听到后获取结果
	2. 通多 RPC 接口调用也可以实现
2. 解耦
	1. 数据产生后需要串行调用 ABC 三个模块，引入 mq 后只需将消息发送到队列，ABC 监听此队列即可。
	2. 数据产生后入库，额外有个定时任务根据数据状态调用 ABC 三个模块
		1. 需要对原数据 pojo 增加状态字段
		2. 只实现了原数据处解耦，但定时任务还是要顺序调用
		3. 再有 D 模块需要消费数据，还是要改定时任务代码
3. 削峰填谷
	1. FIFO 特性
##### 用了后优缺点

1. 系统可用性降低，mq 挂了影响消费端
2. 系统复杂度提高
	1. 消息重复消费、消息丢失、消息顺序性等问题
3. 数据一致性问题
	1. 生产端发送消息后，消费端可能未成功消费

1. 独立部署
	1. 相比于进程内队列，可跨进程、持久化。（缓存也如此）
2. 先进先出
	1. 消息顺序性，削峰填谷
3. 发布订阅模型
	1. 主动权在消费者端，消费者自由订阅感兴趣队列
	2. 生产者不关心有多少个消费者，解耦


### 怎么保证 mq 的高可用（rabbitmq）
1. 单机
2. 普通集群
		1. queue 只会放在一个 master mq 上，其他实例都同步那个接收消息的 RabbitMQ 元数据
		2. 在消费消息的时候，如果你连接到的 RabbitMQ 实例不是存放 Queue 数据的实例，这个时候 RabbitMQ 就会从存放 Queue 数据的实例上拉去数据，然后返回给客户端。
		3. 不是真正的分布式
3. 镜像集群
	1. 创建的 queue 无论元数据还是 queue 里的消息都会存在于多个实例上
	2. 每次写消息到 queue 的时候，都会自动把消息到多个实例的 queue 里进行消息同步
4. 多活

### 怎么保证消息不丢失
[怎么保证 mq 消息不丢失 (rabbitmq)](怎么保证%20mq%20消息不丢失%20(rabbitmq).md)

### 如何保证消息的顺序性？
需要保持先后顺序的消息放入同一个消息队列中，只让一个消费者去消费消息
##### 什么情况会出现
1. 一个 queue，多个 consumer 消费
2. 一个 queue，一个 consumer，多个线程消费
##### 解决策略
1. 拆分成多个 queue，每个 queue 一个 consumer，内部顺序消费
2. consumer 内部队列对消息排队
[关于MQ的几件小事（五）如何保证消息按顺序执行 - 掘金](https://juejin.cn/post/6844903849103196173)

### 消息积压问题如何解决？
[关于MQ的几件小事（六）消息积压在消息队列里怎么办 - 掘金](https://juejin.cn/post/6844903849107406856)

### 消息重复消费怎么解决
[关于MQ的几件小事（三）如何保证消息不重复消费 - 掘金](https://juejin.cn/post/6844903849094807560)

![RabbitMQ 消息中间件技术精讲](RabbitMQ%20消息中间件技术精讲.md#3-4%20幂等性概念及业界主流解决方案%2014%2002)


