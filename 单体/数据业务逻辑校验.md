# 数据业务逻辑校验

[Spring Validation](Spring%20Validation.md)
只涉及一张表的，下沉到底层业务接口就可以，也符合高内聚，下边主要讨论一个请求多个模块多张表，以期用业务验证前置避免进行数据补偿来快速失败。业务验证通过，后续代码问题数据库问题网络问题等导致的数据问题通过分布式事务解决。

##### 问题：
1. 数据业务正确性判断，一种情况是业务复杂，牵扯多张表，这种情况必须在代码里组织业务判断。还有一种是较为简单的，比如字段唯一性判断，这种情况，**依赖数据库唯一索引判断还是写代码判断？** 以及并发下，代码唯一字段为真，但同时并发新增多条数据情况（[幂等性](幂等.md#幂等概念)）。
   1. [数据库设计规范](https://www.zhihu.com/question/39967106) 数据库规范，写的很全
   2. [给数据库字段添加唯一性的字段约束有什么弊端吗-v2ex](https://www.v2ex.com/t/619930)
	   1. 在代码里判断
		   1. 并发。要自己实现，要控制并发和加锁。
		   2. 索引。唯一性的校验取出的数据没有索引，没有数据库效率高。
		   3. 性能。每次插入更新之前都要查一次数据库，好像也没有减少数据库的性能消耗。还不如让数据库系统自己校验。
	   2. 数据库中做
		   1. 数据库唯一约束,分表无法使用
		   2. 跟不上业务，不如代码更改方便
	   3. 代码判断要做，有问题直接报错返回，数据库约束也要加，遇到并发 /业务漏洞可以兜底
   3. [数据库唯一索引DuplicateKeyException异常的优化](https://www.cnblogs.com/buguge/p/15113553.html )唯一索引是兜底，也要在代码里加分布式锁解决
   4. 阿里索引规约 提到做了代码校验也要用唯一索引
   5. mybatisplus 唯一索引与逻辑删除 逻辑删除时delflag值为id，以解决若delflag删除为1，不能重复删除情况
   6. [MySQL在唯一索引中允许存在值为NULL](https://blog.csdn.net/codingtu/article/details/86683000) 联合唯一索引，若某个字段为null，可重复插入
   7. [Java多线程并发数据错乱了，接口幂等性如何设计？](https://developer.51cto.com/article/704511.html )并发场景下唯一性字段判断失效，如何幂等

2. 以及在以往代码里入库操作往往统一切面处理异常，是否有必要针对jdbc异常或数据库异常进行异常处理？感觉对于前端没有必要，后台日志有必要细分这些数据库异常。
3. 如果是java程序需要捕获：DuplicateKeyException异常，如果使用了spring框架还需要捕获MySQLIntegrityConstraintViolationException异常。
4. 这里还有一个点是当前业务流程为A-》B-》C,那么BC的业务性校验是否有必要提前到入口A处？假如提到A处就会出现耦合，也存在别的地方调BC接口情况。假如不提前，若A处有数据入库就要做补偿。把BC业务验证再提供一个接口，在A中先验证数据，再执行业务。另一个思路是DDD,pojo中包含自验证方法。


##### 如何解决：
第一个问题假若只依赖唯一索引，若多模块则有可能出现需要补偿的情况，AB正常存入C失败。同样为了避免补偿，第三个问题也应该是在入口处校验，是通过接口还是Pojo自包含验证方法，还需再对比一下。

pojo自包含验证方法：
1. Pojo为提供给其他模块的API，只有API接口和Pojo，但是验证逻辑需要数据库交互。
2. 基于 1 不可避免，还是需要提供验证 API 接口。
3. DDD 的服务编排层不清楚该如何组织。
   还有就是《凤凰架构》中提到的自定义Bean Validation ，这跟DDD的Domain primitive差不多，但同样解决不了验证前置这种情况。业务验证必然与数据库产生交互，也就是怎么将B模块数据库与A不产生强耦合，目前看只能是提供接口解耦。

抽取验证方法为接口：
1. 在A处，调用BC的验证接口，为了保证A接口并发，以及多服务实例A接口并发，要加分布式锁。但也会存在D模块调用BC接口情况，这种情况依靠简单的AD入口的[分布式锁](分布式锁)控制不住。
2. 不仅仅在AD处验证，在BC入口同样再次验证
   1. 当锁下沉到最基础的接口，锁粒度越细，并发控制越好
   2. 但同样，对于入口接口来说不好控制，可能要做补偿，涉及[分布式事务](../分布式/数据一致性/分布式事务.md)。

针对于上述多个入口调用同一底层接口来说，更应该考虑接口设计是否合理，为什么会出现多个入口情况？
##### 总结：
BC 作为单独服务向前端提供接口 CRUD,  A、D 模块的操作会调用到 BC 的写操作。那么
1. 针对于 ABCD 多实例导致的并发问题，[分布式锁](分布式锁) + 数据库兜底
2. 针对于 A、D -> BC，A、D 加锁，BC 也加锁。

##### K12 案例
新建考试过程，一场考试创建成功需满足实验室可用，老师学生可参加，都需要校验时间是否冲突
1. 在提供可选取实验室，老师学生数据的时候，查库进行一次数据筛选，这样保证了在当前操作下数据是可用的
2. 在点击最后保存进入后台接口进行业务数据校验
3. 并发情况下，在validate校验后，获取[分布式锁](分布式锁)，进行业务逻辑校验。
4. [分布式事务](../分布式/数据一致性/分布式事务.md)

[分布式锁和分布式事务分别解决了什么问题？](分布式/分布式.md#分布式锁和分布式事务分别解决了什么问题)