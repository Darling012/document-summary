# 租户是什么？

探讨与实现如何于多用户的环境下**共用相同的系统或程序组件**，并且仍可确保各用户间**数据的隔离性**。

1. [SaaS 语境下的账户和租户](https://www.woshipm.com/pd/5184398.html)
2. [谈谈对多租户系统的简要理解](https://www.woshipm.com/pd/4353196.html)
3. [基于业务中台的多租户权限管理设计方案](https://www.woshipm.com/pd/2956772.html)

# 如何实现？

1.  行级别： 在每个数据库表里添加tenat_id字段，然后在每个查询语句也添加相应的tenant_id 
2.  [schema](PostgreSQL.md#模式) 级别： 每个租户有在同一个数据库内自己独立命名空间。 可以容易使用 PostgreSQL schemas 来实现。mysql 借助中间件分库分表实现。 

3. 数据库级别：每个租户创建独立的数据库。 

![](image%20(2).png)

# 用户、权限、租户关系

用户角色在租户之下。用租户隔离场景。所谓场景不同，即部门组织架构，角色对应权限在不同公司不相同。根本还是租户隔离数据，共享的只是硬编码的流程业务。

![](Pasted%20image%2020221101112058.png)

组织架构决定用户层级，角色决定权限，而角色的赋予和用户本身的组织结构节点是没有关系的

租户隔离数据，权限定义资源。

# 角色设计

系统组成：

1. 基础通用模块。日志、租户、
2. 业务模块
   1. 同产品业务
   2. 租户特定业务

角色需求：

1. 平台管理员： 负责平台的日常维护和管理，包括日志的管理、租户管理，要注意的是平台管理员不能对租户的具体业务进行管理。如果租户数量大，还可以对平台管理员划分角色，管理不同的租户。
2. 租户管理员：为租户下角色分配权限和相关系统管理、维护。各租户拥有自己的角色和权限，相互不能影响。不同租户的数据、服务在物理上共享，而在逻辑上完全隔离。

 +  是否需要业务管理员即平台之下租户之上。场景为基础通用模块有不能给业务使用情况，或者需要区分业务即平台管理员按地域按细分业务划分，实则为区分资源权限。那么这个权限的设置跟租户之下的权限就不是一套。此权限不分区租户。这个地方的矛盾在于，如何让角色在租户之上。这个需求也可对应到同一角色跨系统。


> 当前系统设计，用表中新增租户 Id 字段实现行级别隔离数据。用 admin 登录，在新增租户后，公司组织架构会新增顶级节点（已有租户 Id），新增租户管理员角色（没有租户 Id）, 分配租户管理员权限（排除租户管理后的基础公共服务），新增租户管理员账号（有租户 Id，在此与角色，部门关联）。在使用此租户管理员登录后，有组织架构顶级节点，没有角色数据，没有用户数据（通过 sql 控制排除当前登录用户）。

> 则当前租户设计为：平台 admin (初始化租户账号)-----切换租户账号-----》租户 admin（初始化业务使用所需基础数据）-----切换业务账号----》登录使用


[动态切换数据源](动态切换数据源.md)
# keycloak

#### user:

系统中登录用户，通过user添加自定义属性来关联业务系统中的用户。在user的role mappings里配置与roles的关联。

##### roles:

role分为两种，一种归属relam，一种归属client，我们一般针对client设置。

##### policies:

policies将角色与权限关联起来，在policy里关联角色，与权限的关联在permissions里。

##### permissions:

访问资源所需权限，关联policy，resources,scope

##### scopes:

用于区分相同URL的get、post等请求方式不同，权限不同

##### resources:

即资源，与scopes产生关联

#### refrence

1. [Keycloak 梳理](https://blog.csdn.net/weiwoyonzhe/article/details/121026133)
2. 
